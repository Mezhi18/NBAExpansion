---
title: "Is it time for an NBA expansion?"
subtitle: "My subtitle if needed"
author: 
  - Yan Mezhiborsky
thanks: "Code and data are available at: https://github.com/Mezhi18/NBAExpansion ."
date: today
date-format: long
abstract: "First sentence. Second sentence. Third sentence. Fourth sentence."
format: pdf
toc: true
number-sections: true
bibliography: references.bib
---

```{r}
#| include: false
#| warning: false
#| message: false

library(tidyverse)
library(knitr)
library(readr)
library(modelsummary)
library(tinytex)
library(lubridate)
```


# Introduction

You can and should cross-reference sections and sub-sections. We use @citeR and @rohan.

The remainder of this paper is structured as follows. @sec-data....



# Data {#sec-data}

Some of our data is of penguins (@fig-bills), from @palmerpenguins.

```{r}
#| include: false
#| warning: false
#| message: false

NBA1980 <- read_csv("../data/raw_data/NBA1980.csv")
NBA1981 <- read_csv("../data/raw_data/NBA1981.csv")
NBA1982 <- read_csv("../data/raw_data/NBA1982.csv")
NBA1983 <- read_csv("../data/raw_data/NBA1983.csv")
NBA1984 <- read_csv("../data/raw_data/NBA1984.csv")
NBA1985 <- read_csv("../data/raw_data/NBA1985.csv")
NBA1986 <- read_csv("../data/raw_data/NBA1986.csv")
NBA1987 <- read_csv("../data/raw_data/NBA1987.csv")
NBA1988 <- read_csv("../data/raw_data/NBA1988.csv")
NBA1989 <- read_csv("../data/raw_data/NBA1989.csv")
NBA1990 <- read_csv("../data/raw_data/NBA1990.csv")
NBA1991 <- read_csv("../data/raw_data/NBA1991.csv")
NBA1992 <- read_csv("../data/raw_data/NBA1992.csv")
NBA1993 <- read_csv("../data/raw_data/NBA1993.csv")
NBA1994 <- read_csv("../data/raw_data/NBA1994.csv")
NBA1995 <- read_csv("../data/raw_data/NBA1995.csv")
NBA1996 <- read_csv("../data/raw_data/NBA1996.csv")
NBA1997 <- read_csv("../data/raw_data/NBA1997.csv")
NBA1998 <- read_csv("../data/raw_data/NBA1998.csv")
NBA1999 <- read_csv("../data/raw_data/NBA1999.csv")
NBA2000 <- read_csv("../data/raw_data/NBA2000.csv")
NBA2001 <- read_csv("../data/raw_data/NBA2001.csv")
NBA2002 <- read_csv("../data/raw_data/NBA2002.csv")
NBA2003 <- read_csv("../data/raw_data/NBA2003.csv")
NBA2004 <- read_csv("../data/raw_data/NBA2004.csv")
NBA2005 <- read_csv("../data/raw_data/NBA2005.csv")
NBA2006 <- read_csv("../data/raw_data/NBA2006.csv")
NBA2007 <- read_csv("../data/raw_data/NBA2007.csv")
NBA2008 <- read_csv("../data/raw_data/NBA2008.csv")
NBA2009 <- read_csv("../data/raw_data/NBA2009.csv")
NBA2010 <- read_csv("../data/raw_data/NBA2010.csv")
NBA2011 <- read_csv("../data/raw_data/NBA2011.csv")
NBA2012 <- read_csv("../data/raw_data/NBA2012.csv")
NBA2013 <- read_csv("../data/raw_data/NBA2013.csv")
NBA2014 <- read_csv("../data/raw_data/NBA2014.csv")
NBA2015 <- read_csv("../data/raw_data/NBA2015.csv")
NBA2016 <- read_csv("../data/raw_data/NBA2016.csv")
NBA2017 <- read_csv("../data/raw_data/NBA2017.csv")
NBA2018 <- read_csv("../data/raw_data/NBA2018.csv")
NBA2019 <- read_csv("../data/raw_data/NBA2019.csv")
NBA2020 <- read_csv("../data/raw_data/NBA2020.csv")
NBA2021 <- read_csv("../data/raw_data/NBA2021.csv")
NBA2022 <- read_csv("../data/raw_data/NBA2022.csv")
NBA2023 <- read_csv("../data/raw_data/NBA2023.csv")

lebron_data <- read_csv("../data/raw_data/NBA_Lebron_James.csv")
scoring_data <- read.csv("../data/raw_data/All_time_Scoring.csv")

```

```{r}
#| include: false
#| warning: false
#| message: false

combined_data <- data.frame()

# Loop through the years 1980 to 2023
for(year in 1980:2023) {
  # Read the CSV file for the year
  file_path <- sprintf("../data/raw_data/NBA%d.csv", year)
  yearly_data <- read_csv(file_path)
  
  # Add a year column
  yearly_data$Year <- year
  
  # Combine with the main data frame
  combined_data <- bind_rows(combined_data, yearly_data)
}

# Add the number of teams to the combined data before selecting columns
combined_data <- combined_data %>%
  mutate(Num_Teams = case_when(
    Year <= 1980 ~ 22,
    Year > 1980 & Year <= 1988 ~ 23,
    Year == 1989 ~ 25,  
    Year > 1989 & Year <= 1995 ~ 27,
    Year > 1995 & Year <= 2004 ~ 29,
    TRUE ~ 30  # For years after 2004
  ))

# Now remove less important columns
full_nba_data <- combined_data %>%
  select(-G, -MP, -Rk)

# Creating table for league average
nba_data <- full_nba_data %>% 
  filter(Team == "League Average")

# Saving Clean Data
write.csv(nba_data, "../data/clean_data/nba_data.csv", row.names = FALSE) #Only League Averages
write.csv(full_nba_data, "../data/clean_data/full_nba_data.csv", row.names = FALSE) #All Teams

scoring_data$Date <- as.Date(scoring_data$Date)

scoring_data$Year <- year(scoring_data$Date) +
  ifelse(month(scoring_data$Date) > 8 | 
         (month(scoring_data$Date) == 8 & day(scoring_data$Date) > 12), 1, 0)

lebron_data$Season <- as.integer(lebron_data$Season)


```

Talk more about it.

And also planes (@fig-planes). (You can change the height and width, but don't worry about doing that until you have finished every other aspect of the paper - Quarto will try to make it look nice and the defaults usually work well once you have enough text.)

```{r}
#| label: fig-planes
#| fig-cap: Relationship between wing length and width
#| echo: false
#| warning: false
#| message: false


```

Talk way more about it. 



# Model

The goal of our modelling strategy is twofold. Firstly,...

Here we briefly describe the Bayesian analysis model used to investigate... Background details and diagnostics are included in [Appendix -@sec-model-details].

## Model set-up

Define $y_i$ as the average number of points per game scored by a team through out the NBA season. Then $\alpha$ is the average assists per game, $\rho$ the average rebounds per game, $\beta$ is blocks per game, $\psi$ is steals per game and lastly, $\tau$ is turnovers per game.

\begin{align} 
y_i|\mu_i, \sigma &\sim \mbox{Normal}(\mu_i, \sigma) \\
\mu_i &= \alpha + \rho_i + \beta_i + \xi_i + \tau_i \\
\alpha &\sim \mbox{Normal}(0, 2.5) \\
\rho &\sim \mbox{Normal}(0, 2.5) \\
\beta &\sim \mbox{Normal}(0, 2.5) \\
\psi &\sim \mbox{Normal}(0,2.5) \\
\tau &\sim \mbox{Normal}(0,2.5) \\
\sigma &\sim \mbox{Exponential}(1) \\
\end{align}

```{r}
#| warning: false
#| message: false

# Fit a multiple linear regression model
nba_model <- lm(PTS ~ Year * Num_Teams + AST + TRB + STL + BLK + TOV, data = nba_data)
nba_model_2 <- lm(PTS ~ Year + Num_Teams + AST + TRB + STL + BLK + TOV, data = nba_data)
model_ny <- lm(PTS ~ Num_Teams + AST + TRB + STL + BLK + TOV, data = nba_data)

plot(model_ny)
# Summary of the linear model
msummary(
  list(
    "times Year" = nba_model,
    "Without Year" = model_ny,
    "plus year" = nba_model_2
  ),
  fmt = 2
  )





summary(model_ny)
summary(nba_model_2)
```





We run the model in R [@citeR] using the `rstanarm` package of @rstanarm. We use the default priors from `rstanarm`.


### Model justification

We expect a positive relationship between the size of the wings and time spent aloft. In particular...

We can use maths by including latex between dollar signs, for instance $\theta$.


# Results

Our results are summarized in @tbl-modelresults.

```{r}
#| echo: false
#| eval: true
#| warning: false
#| message: false

# Reshape data from wide to long format
nba_data_long <- nba_data %>%
  pivot_longer(cols = c(AST, TRB, PTS, STL, BLK, TOV), names_to = "Statistic", values_to = "Value")

line_colors <- c("red", "green", "blue", "purple", "orange", "cyan")

exp_year <- c(1988, 1989, 1995, 2004) #Expansion Year

combined_plot <- ggplot(nba_data_long, aes(x = Year, y = Value)) +
  geom_point(color = "black") +  # All points in black
  geom_smooth(method = "lm", aes(color = Statistic), se = FALSE) +  # Lines of best fit with different colors
  scale_color_manual(values = line_colors) +
  geom_vline(xintercept = exp_year, color = "black", linetype = "dashed") +
  facet_wrap(~Statistic, scales = "free_y") +  # Facet by statistic, with free y scales
  labs(title = "NBA Stats Over Years", x = "Year", y = "Value") +
  theme_minimal() +
  theme(legend.position = "none")

combined_plot

```


```{r}
#| echo: false
#| eval: true
#| warning: false
#| message: false

current_nba_data_long <- nba_data %>%
  filter(Year >= 2004) %>%  # Keep only years from 2004 onwards
  pivot_longer(cols = c(AST, TRB, PTS, STL, BLK, TOV), names_to = "Statistic", values_to = "Value")

current_plot <- ggplot(current_nba_data_long, aes(x = Year, y = Value)) +
  geom_point(color = "black") +  # All points in black
  geom_smooth(method = "lm", aes(color = Statistic), se = FALSE) +  # Lines of best fit with different colors
  scale_color_manual(values = line_colors) +
  facet_wrap(~Statistic, scales = "free_y") +  # Facet by statistic, with free y scales
  labs(title = "NBA Stats Over Years (Post-2004)", x = "Year", y = "Value") +
  theme_minimal() +
  theme(legend.position = "none")

current_plot
```


```{r}
#| echo: false
#| eval: true
#| warning: false
#| message: false

ggplot(scoring_data, aes(x = Year, fill = factor(Year))) +
  geom_histogram(stat = "count", binwidth = 1, color = "black") +
  labs(title = "Frequency of Records by Year",
       x = "Year",
       y = "Count of Records",
       fill = "Year") +
  theme_minimal() +
  theme(legend.position = "none")
##
data_1980_onwards <- scoring_data %>%
  filter(Year >= 1980)

# Create histogram for count of records per year from 1980 onwards
ggplot(data_1980_onwards, aes(x = Year)) +
  geom_histogram(stat = "count", bins = length(unique(data_1980_onwards$Year)), fill = "blue", color = "black") +
  labs(title = "Count of Records per Year from 1980 Onwards",
       x = "Year Modified",
       y = "Count of Records") +
  theme_minimal()

##
data_1980_60pts_plus <- scoring_data %>%
  filter(Year >= 1980, PTS >= 70)

# Create histogram for count of records per year for scores of 60 or more from 1980 onwards
ggplot(data_1980_60pts_plus, aes(x = Year)) +
  geom_histogram(stat = "count", bins = length(unique(data_1980_60pts_plus$Year)), fill = "red", color = "black") +
  labs(title = "Count of Records per Year for Scores of 60+ PTS from 1980 Onwards",
       x = "Year Modified",
       y = "Count of Records") +
  theme_minimal()
```

```{r}


nba_avg_pts <- nba_data %>%
  group_by(Year) %>%
  summarize(Avg_PTS = mean(PTS, na.rm = TRUE))

comparison_data <- lebron_data %>%
  rename(Year = Season) %>%  # Rename Season to Year for merging
  left_join(nba_avg_pts, by = "Year") %>%
  mutate(Ratio = PTS / Avg_PTS)

ggplot(comparison_data, aes(x = Year, y = Ratio)) +
  geom_point(aes(color = Year), size = 3) +
  geom_smooth(method = "lm", se = FALSE, color = "navy") +
  labs(title = "LeBron's PTS as a Ratio to NBA Average PTS Across Seasons",
       x = "Season",
       y = "Ratio of LeBron's PTS to NBA Average PTS") +
  theme_minimal()

ggplot(comparison_data, aes(x = Year, y = Ratio, fill = Year)) +
  geom_bar(stat = "identity", color = "black") +
  labs(title = "LeBron's PTS as a Ratio to NBA Average PTS Across Seasons (Bar Graph)",
       x = "Season",
       y = "Ratio of LeBron's PTS to NBA Average PTS") +
  theme_minimal() +
  theme(legend.position = "none")

```



# Discussion

## First discussion point {#sec-first-point}

If my paper were 10 pages, then should be be at least 2.5 pages. The discussion is a chance to show off what you know and what you learnt from all this. 

## Second discussion point

## Third discussion point

## Weaknesses and next steps

Weaknesses and next steps should also be included.

\newpage

\appendix

# Appendix {-}


# Additional data details

# Model details {#sec-model-details}

## Posterior predictive check

In @fig-ppcheckandposteriorvsprior-1 we implement a posterior predictive check. This shows...

In @fig-ppcheckandposteriorvsprior-2 we compare the posterior with the prior. This shows... 



## Diagnostics

@fig-stanareyouokay-1 is a trace plot. It shows... This suggests...

@fig-stanareyouokay-2 is a Rhat plot. It shows... This suggests...





\newpage


# References


